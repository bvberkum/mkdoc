#!/bin/bash

source lib.sh

test -n "$1" -a "$1" != "." && {
  PREFIX="$1"
} || noop

test -n "$PREFIX" || {
  test "$ENV" = "development" && {
    PREFIX='$(CURDIR)/usr/'
  } || {
    # production?
    PREFIX=/usr/local
  }
}

[ -z "$2" ] || ENV=$2
[ -n "$ENV" ] || ENV=development

test -n "$SRC_PREFIX" || {
  case "$ENV" in
    development )
      SRC_PREFIX=/tmp ;;
    production )
      SRC_PREFIX=/src ;;
  esac
}

echo PREFIX=$PREFIX
echo "ENV=$ENV"
echo SRC_PREFIX=SRC_$PREFIX

function rewrite_mk_prefix()
{
  sed_rewrite_tag 's#^PREFIX\(.*[:?]\)=.*#PREFIX\1= '$PREFIX'#' $1
  echo "Updated PREFIX in $1 (to $PREFIX):"
  grep 'PREFIX.*=' $1
}
function rewrite_sh_prefix()
{
  sed_rewrite_tag 's#^PREFIX=.*#PREFIX='$PREFIX'#' $1
  echo "Updated PREFIX in $1 (to $PREFIX):"
  grep 'PREFIX.*=' $1
}
function rewrite_sh_src_prefix()
{
  sed_rewrite_tag 's#^SRC_PREFIX=.*#SRC_PREFIX='$SRC_PREFIX'#' $1
  echo "Updated SRC_PREFIX in $1 (to $SRC_PREFIX):"
  grep 'SRC_PREFIX.*=' $1
}

rewrite_mk_prefix Mkdoc-full.mk
rewrite_mk_prefix Mkdoc-minimal.mk

rewrite_sh_prefix install-dependencies.sh
rewrite_sh_src_prefix install-dependencies.sh

rewrite_sh_prefix install.sh

